require(["gitbook","jQuery","lodash"],function(t,e,n){function o(e){var n=t.state.$book.find(".page-wrapper"),o=n.find(".page-inner"),a=t.state.$book.find(".navigation.navigation-next");if(n.toggleClass("comments-open",e),n.hasClass("comments-open")){var i=330,c=o.width(),s=n.width(),r=0==a.length?0:a.width(),m=(s-c)/2-r,l=m-i;l=Math.max(l,-i),l=Math.min(l,0),o.css("left",l+"px")}else o.css("left","0px")}function a(e){return(t.state.root+"/gitbook/api/"+e).replace(/([^:]\/)\/+/g,"$1")}function i(){location.href=a("login")}function c(t){var e=window.open(t,"_blank");e.focus()}function s(t,n,o,i){e.ajax({method:t,dataType:"json",url:a(n),data:o,success:function(t,e,n){E=!0,O=!!n.getResponseHeader("X-GitBook-Auth"),i(t)},error:function(t,e){E&&(alert("Error processing comments: "+e),console.log(t,e))}})}function r(){s("GET","discussions",{filename:t.state.filepath,state:"open"},function(t){P=t.list,S()})}function m(t){s("GET","discussions/"+t+"/comments",{limit:M},function(e){j[t]=e,$(t)})}function l(e,n,o,a){s("POST","discussions",{title:e,body:n,context:{filename:t.state.filepath,chapterTitle:t.state.chapterTitle,section:o}},a)}function u(t){P=n.reject(P,{number:t}),S(),s("POST","discussions/"+t,{state:"closed"},function(){r()})}function p(t,e,n){s("POST","discussions/"+t+"/comments",{body:e},function(e){j[t]=j[t]||[],j[t].total=j[t].total+1,j[t].list.push(e),$(t),m(t),n(e)})}function d(t){var e=t.split(" ");return n.chain(P).map(function(t){var o=(t.context.section||"").split(" "),a=n.filter(o,function(t){return n.contains(e,t)}),i=n.filter(e,function(t){return n.contains(o,t)}),c=(a.length/o.length+i.length/e.length)/2;return{matching:c,thread:t}}).filter(function(t){return t.matching>.8}).sortBy("matching").pluck("thread").value()}function f(t){return t.clone().find(".comments-area,.comments-icon").remove().end().text()}function h(t,n){console.log(f(n));var o,a,c=e("<div>",{"class":"comments-post"});if(O){o=e("<input>",{type:"text",placeholder:"Start a new discussion"}),a=e("<input>",{type:"text",placeholder:"Optional comment"});var s=b([{text:"Post",click:function(){l(o.val(),a.val(),f(n),function(e){P.push(e),S(),x(t,n,e)})}}]);a.hide(),o.keyup(function(t){o.val().length>3?a.show():a.val()||a.hide()}),c.append(o),c.append(a),c.append(s)}else{var s=b([{text:"Sign in to comment",click:i}]);c.append(s)}t.empty(),t.append(c),o&&o.focus()}function v(t){return e("<div>",{"class":"thread",html:N({thread:t})})}function g(t,n){return e("<div>",{"class":"comment",html:B({comment:t})})}function b(t){var o=e("<div>",{"class":"comments-toolbar"});return n.each(t,function(t){var n=e("<a>",{href:"#",text:t.text,click:function(e){e.preventDefault(),t.click()}});n.appendTo(o)}),o}function k(t,n){t.empty();var o=e("<input>",{type:"text",placeholder:"Leave a comment"}),a=b([{text:"Post",click:function(){p(n.number,o.val(),function(){o.val("")})}}]);t.append(o),t.append(a),o.focus()}function x(t,n,o,a){m(o.number);var c=[];O?(o.permissions.comment&&c.push({text:"Comment",click:function(){k(s,o)}}),o.permissions.close&&c.push({text:"Close",click:function(){T(n,a),u(o.number)}}),c.push({text:"New Thread",click:function(){h(t,n)}})):c=[{text:"Sign in to comment",click:i}];var s=e("<div>",{"class":"comments-post"});s.append(b(c));var r=e("<div>",{"class":"comments-list","data-thcomments":o.number});t.empty(),t.append(g(o)),t.append(r),t.append(s),$(o.number)}function y(t,o,a){var c=e("<div>",{"class":"comments-threads"});n.each(a,function(e){var n=v(e);n.click(function(n){x(t,o,e)}),c.append(n)});var s;s=b(O?[{text:"New Thread",click:function(){h(t,o)}}]:[{text:"Sign in to create a thread",click:i}]),t.empty(),t.append(c),t.append(s)}function w(){t.state.$book.find(".page-wrapper .comments-section").removeClass("has-comments-open")}function T(t,n){var a=!t.hasClass("has-comments-open");if(w(),t.toggleClass("has-comments-open",a),o(a),a){t.find(".comments-area").remove();var i=e("<div>",{"class":"comments-area"});t.append(i),n.length>1?y(i,t,n):1==n.length?x(i,t,n[0],n):h(i,t)}}function C(t){var o=f(t);if(!(o.length<5)){var a=d(o),i=n.reduce(a,function(t,e){return t+1+e.comments},0),c=e("<div>",{"class":"marker",text:i?i:"+"});c.on("click",function(){T(t,a)});var s=e("<div>",{"class":"comments-icon"});s.append(c),t.find(".comments-icon").remove(),t.addClass("comments-section"),t.toggleClass("has-comments",i>0),t.append(s)}}function S(){var n=t.state.$book.find(".page-wrapper"),o=n.find(G);o.each(function(){C(e(this))})}function $(e){var o=n.find(P,{number:e});if(j[e]&&o){var a=t.state.$book.find('.page-wrapper div[data-thcomments="'+e+'"]');if(0!=a.length){a.empty();var i=Math.max(0,j[e].total-M);i>0&&a.append(b([{text:"View "+i+" more comments",click:function(){c(o.urls.details)}}])),n.chain(j[e].list||[]).reverse().each(function(t){a.append(g(t))}).value()}}}var P=[],j={},O=!1,E=!1,G="p",M=4,B=n.template('<img src="<%- comment.user.urls.avatar %>" class="comment-avatar" /><div class="comment-body"><a href="<%- comment.user.urls.profile %>" target="_blank" class="comment-user"><%- comment.user.name %></a><div class="comment-content"><% if (comment.title) { %><%- comment.title %><% if (comment.body) { %><br/><% } %><% } %><%= comment.body || "" %></div></div>'),N=n.template('<div class="thread-body"><div class="thread-title"><%- thread.title %></div><div class="thread-user">#<%- thread.number %> posted by <%- thread.user.name %></div></div>');t.events.bind("start",function(t,e){}),t.events.bind("page.change",function(){P=[],r()})});
